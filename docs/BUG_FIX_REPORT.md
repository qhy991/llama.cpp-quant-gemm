# é‡åŒ–GEMMæ•°æ®å¸ƒå±€ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†é‡åŒ–GEMMå®ç°ä¸­çš„æ•°æ®å¸ƒå±€é”™è¯¯åŠå…¶ä¿®å¤è¿‡ç¨‹ã€‚ä¸»è¦é—®é¢˜åŒ…æ‹¬ï¼š
1. Q8_0/Q8_1 æ•°æ®å¸ƒå±€è¯¯è§£ï¼ˆäº¤é”™ vs é¡ºåºï¼‰
2. Q4_1, Q5_0, Q5_1 kernel ä¸­ Q8_1 æ•°æ®åŠ è½½é”™è¯¯
3. Q5_0, Q5_1 ä¸­ qh (high bit) å¸ƒå±€é”™è¯¯
4. CPU å‚è€ƒå®ç°ä¸ llama.cpp ä¸ä¸€è‡´

**ä¿®å¤ç»“æœ**: âœ… Q4_0, Q4_1, Q5_0, Q5_1 å…¨éƒ¨é€šè¿‡æµ‹è¯•

---

## ğŸ” é—®é¢˜å‘ç°è¿‡ç¨‹

### åˆå§‹çŠ¶æ€

æµ‹è¯• `test_gemm_all_quants` æ—¶å‘ç°ï¼š
- âœ… Q4_0: PASSED
- âŒ Q4_1: FAILED (æ•°å€¼ä¸åŒ¹é…)
- âŒ Q5_0: FAILED (æ•°å€¼ä¸åŒ¹é…)
- âŒ Q5_1: FAILED (æ•°å€¼ä¸åŒ¹é…)
- âš ï¸ Q8_0: è¢« "misaligned address" é”™è¯¯ä¸­æ–­

### é—®é¢˜åˆ†æ

é€šè¿‡å¯¹æ¯” Q4_0 (é€šè¿‡) å’Œ Q4_1 (å¤±è´¥) çš„å®ç°ï¼Œå‘ç°äº†å…³é”®å·®å¼‚ï¼š

1. **Q8_1 æ•°æ®å¸ƒå±€å‡è®¾ä¸ä¸€è‡´**
   - Q4_0 kernel ä½¿ç”¨: `load_int_b4(bq8->qs, i)` å’Œ `load_int_b4(bq8->qs, i + 4)`
   - Q4_1 kernel ä½¿ç”¨: `load_int_b4(bq8->qs, 2*i + 0)` å’Œ `load_int_b4(bq8->qs, 2*i + 1)`

2. **qh (high bit) å¸ƒå±€é”™è¯¯**
   - CPU å‚è€ƒå®ç°ä½¿ç”¨: `(qh >> (i*2 + 0))` å’Œ `(qh >> (i*2 + 1))`
   - å®é™… llama.cpp å¸ƒå±€: `bits 0-15` å¯¹åº” `x[0..15]`, `bits 16-31` å¯¹åº” `x[16..31]`

---

## ğŸ“Š æ•°æ®å¸ƒå±€è¯¦è§£

### llama.cpp çš„å®é™…å¸ƒå±€

#### Q8_1 æ¿€æ´»å€¼å¸ƒå±€

```cpp
// llama.cpp/ggml/src/ggml-quants.c: quantize_row_q8_1
for (int j = 0; j < QK8_1/2; ++j) {  // j = 0..15
    const float v0 = x[i*QK8_1           + j]*id;  // x[0], x[1], ..., x[15]
    const float v1 = x[i*QK8_1 + QK8_1/2 + j]*id;  // x[16], x[17], ..., x[31]
    
    y[i].qs[          j] = roundf(v0);  // qs[0..15] = x[0..15]
    y[i].qs[QK8_1/2 + j] = roundf(v1);  // qs[16..31] = x[16..31]
}
```

**ç»“è®º**: Q8_1 æ˜¯**é¡ºåºå­˜å‚¨**ï¼Œä¸æ˜¯äº¤é”™çš„ï¼
- `qs[0] = x[0]`, `qs[1] = x[1]`, ..., `qs[31] = x[31]`

#### Q4_0/Q4_1/Q5_0/Q5_1 æƒé‡å¸ƒå±€

```cpp
// llama.cpp: äº¤é”™åŠå—å¸ƒå±€
for (int j = 0; j < qk/2; ++j) {  // j = 0..15
    const float x0 = x[i*qk + 0    + j]*id;  // x[0..15]
    const float x1 = x[i*qk + qk/2 + j]*id;  // x[16..31]
    
    y[i].qs[j] = (xi0 & 0x0F) | ((xi1 & 0x0F) << 4);
    // qs[j] çš„ä½ nibble = x[j], é«˜ nibble = x[j+16]
}
```

**ç»“è®º**: 4-bit/5-bit æƒé‡ä½¿ç”¨**äº¤é”™åŠå—å¸ƒå±€**
- `qs[i]` çš„ä½ nibble = `x[i]`
- `qs[i]` çš„é«˜ nibble = `x[i+16]`

#### Q5_0/Q5_1 çš„ qh (high bit) å¸ƒå±€

```cpp
// llama.cpp: qh å¸ƒå±€
qh |= ((xi0 & 0x10u) >> 4) << (j + 0);       // bits 0-15 for x[0..15]
qh |= ((xi1 & 0x10u) >> 4) << (j + qk/2);    // bits 16-31 for x[16..31]
```

**ç»“è®º**: qh æ˜¯**åˆ†æ®µå¸ƒå±€**ï¼Œä¸æ˜¯äº¤é”™çš„
- `bits 0-15`: `x[0..15]` çš„ç¬¬ 5 bit
- `bits 16-31`: `x[16..31]` çš„ç¬¬ 5 bit

---

## ğŸ› ä¿®å¤å‰çš„é—®é¢˜

### é—®é¢˜ 1: Q8_0 é‡åŒ–å‡½æ•°é”™è¯¯ï¼ˆå·²ä¿®å¤ï¼‰

**ä¿®å¤å‰**:
```cpp
// âŒ é”™è¯¯ï¼šå‡è®¾ Q8_0 æ˜¯äº¤é”™å¸ƒå±€
for (int i = 0; i < 16; i++) {
    int8_t v0 = roundf(block_src[i] * inv_scale);
    int8_t v1 = roundf(block_src[i + 16] * inv_scale);
    dst[b].qs[i] = v0;
    dst[b].qs[i + 16] = v1;  // é”™è¯¯ï¼šåº”è¯¥æ˜¯é¡ºåºå­˜å‚¨
}
```

**ä¿®å¤å**:
```cpp
// âœ… æ­£ç¡®ï¼šQ8_0 æ˜¯é¡ºåºå­˜å‚¨
for (int i = 0; i < block_size; i++) {
    int8_t v = roundf(block_src[i] * inv_scale);
    dst[b].qs[i] = v;  // é¡ºåºå­˜å‚¨
}
```

### é—®é¢˜ 2: Q4_1/Q5_0/Q5_1 Kernel ä¸­ Q8_1 åŠ è½½é”™è¯¯

**ä¿®å¤å‰ (Q4_1)**:
```cpp
// âŒ é”™è¯¯ï¼šåŠ è½½äº†è¿ç»­çš„ Q8_1 å€¼
int u0 = load_int_b4(bq8->qs, 2*i + 0);  // åŠ è½½ qs[0..3]
int u1 = load_int_b4(bq8->qs, 2*i + 1);  // åŠ è½½ qs[4..7] âŒ é”™è¯¯ï¼
```

**é—®é¢˜åˆ†æ**:
- Q4_1 æƒé‡: `vi0 = x[0..3]`, `vi1 = x[16..19]`
- é”™è¯¯åŠ è½½: `u0 = x[0..3]` âœ“, `u1 = x[4..7]` âŒ
- åº”è¯¥åŠ è½½: `u0 = x[0..3]` âœ“, `u1 = x[16..19]` âœ“

**ä¿®å¤å**:
```cpp
// âœ… æ­£ç¡®ï¼šåŠ è½½å¯¹åº”çš„å‰åŠéƒ¨åˆ†å’ŒååŠéƒ¨åˆ†
int u0 = load_int_b4(bq8->qs, i);      // åŠ è½½ qs[i*4:i*4+3] = x[i*4:i*4+3]
int u1 = load_int_b4(bq8->qs, i + 4);  // åŠ è½½ qs[(i+4)*4:(i+4)*4+3] = x[16+i*4:16+i*4+3]
```

### é—®é¢˜ 3: Q5_0/Q5_1 Kernel ä¸­ qh æå–é”™è¯¯

**ä¿®å¤å‰**:
```cpp
// âŒ é”™è¯¯ï¼šå‡è®¾ qh æ˜¯è¿ç»­å¸ƒå±€
int bit_offset = i * 8;
vi0 |= ((qh >> (bit_offset + 0)) & 1) << 4;   // bit 0,1,2,3
vi0 |= ((qh >> (bit_offset + 1)) & 1) << 12;
vi0 |= ((qh >> (bit_offset + 2)) & 1) << 20;
vi0 |= ((qh >> (bit_offset + 3)) & 1) << 28;

vi1 |= ((qh >> (bit_offset + 4)) & 1) << 4;   // bit 4,5,6,7 âŒ é”™è¯¯ï¼
vi1 |= ((qh >> (bit_offset + 5)) & 1) << 12;
vi1 |= ((qh >> (bit_offset + 6)) & 1) << 20;
vi1 |= ((qh >> (bit_offset + 7)) & 1) << 28;
```

**é—®é¢˜åˆ†æ**:
- `vi0` å¯¹åº” `x[i*4..i*4+3]`ï¼Œåº”è¯¥ä» `qh` çš„ `bits i*4..i*4+3` æå– âœ“
- `vi1` å¯¹åº” `x[16+i*4..16+i*4+3]`ï¼Œåº”è¯¥ä» `qh` çš„ `bits 16+i*4..16+i*4+3` æå–
- ä½†ä»£ç ä» `bits 4+i*4..7+i*4` æå– âŒ

**ä¿®å¤å**:
```cpp
// âœ… æ­£ç¡®ï¼šåˆ†åˆ«ä»å‰ååŠæ®µæå–
int bit_offset_0 = i * 4;      // vi0 å¯¹åº” x[i*4..i*4+3]
int bit_offset_1 = 16 + i * 4; // vi1 å¯¹åº” x[16+i*4..16+i*4+3]

vi0 |= ((qh >> (bit_offset_0 + 0)) & 1) << 4;   // bit i*4+0
vi0 |= ((qh >> (bit_offset_0 + 1)) & 1) << 12;  // bit i*4+1
vi0 |= ((qh >> (bit_offset_0 + 2)) & 1) << 20;  // bit i*4+2
vi0 |= ((qh >> (bit_offset_0 + 3)) & 1) << 28;  // bit i*4+3

vi1 |= ((qh >> (bit_offset_1 + 0)) & 1) << 4;   // bit 16+i*4+0
vi1 |= ((qh >> (bit_offset_1 + 1)) & 1) << 12;  // bit 16+i*4+1
vi1 |= ((qh >> (bit_offset_1 + 2)) & 1) << 20;  // bit 16+i*4+2
vi1 |= ((qh >> (bit_offset_1 + 3)) & 1) << 28;   // bit 16+i*4+3
```

### é—®é¢˜ 4: CPU å‚è€ƒå®ç°ä¸­ qh æå–é”™è¯¯

**ä¿®å¤å‰ (Q5_0)**:
```cpp
// âŒ é”™è¯¯ï¼šå‡è®¾ qh æ˜¯äº¤é”™å¸ƒå±€
int w0 = (w.qs[i] & 0x0F) | (((qh >> (i*2 + 0)) & 1) << 4);
int w1 = ((w.qs[i] >> 4) & 0x0F) | (((qh >> (i*2 + 1)) & 1) << 4);
```

**é—®é¢˜åˆ†æ**:
- å½“ `i=0`: `w0` ä» `bit 0` æå– âœ“, `w1` ä» `bit 1` æå– âŒ (åº”è¯¥æ˜¯ `bit 16`)
- å½“ `i=1`: `w0` ä» `bit 2` æå– âœ“, `w1` ä» `bit 3` æå– âŒ (åº”è¯¥æ˜¯ `bit 17`)

**ä¿®å¤å**:
```cpp
// âœ… æ­£ç¡®ï¼šåˆ†åˆ«ä»å‰ååŠæ®µæå–
int w0 = (w.qs[i] & 0x0F) | (((qh >> i) & 1) << 4);           // bit i
int w1 = ((w.qs[i] >> 4) & 0x0F) | (((qh >> (i + 16)) & 1) << 4); // bit i+16
```

### é—®é¢˜ 5: Q5_0/Q5_1 é‡åŒ–å‡½æ•°ä¸­ qh å­˜å‚¨é”™è¯¯

**ä¿®å¤å‰**:
```cpp
// âŒ é”™è¯¯ï¼šå­˜å‚¨ä¸ºäº¤é”™å¸ƒå±€
qh |= ((q0 >> 4) & 1) << (i*2 + 0);  // bit 0,2,4,6,... for x[0..15]
qh |= ((q1 >> 4) & 1) << (i*2 + 1);  // bit 1,3,5,7,... for x[16..31]
```

**ä¿®å¤å**:
```cpp
// âœ… æ­£ç¡®ï¼šå­˜å‚¨ä¸ºåˆ†æ®µå¸ƒå±€
qh |= ((q0 >> 4) & 1) << i;           // bits 0-15 for x[0..15]
qh |= ((q1 >> 4) & 1) << (i + 16);    // bits 16-31 for x[16..31]
```

---

## ğŸ“ˆ ä¿®å¤å‰åå¯¹æ¯”

### æµ‹è¯•ç»“æœå¯¹æ¯”

| æ ¼å¼ | ä¿®å¤å‰ | ä¿®å¤å | çŠ¶æ€ |
|------|--------|--------|------|
| Q4_0 | âœ… PASS | âœ… PASS | æ— å˜åŒ– |
| Q4_1 | âŒ FAIL | âœ… PASS | å·²ä¿®å¤ |
| Q5_0 | âŒ FAIL | âœ… PASS | å·²ä¿®å¤ |
| Q5_1 | âŒ FAIL | âœ… PASS | å·²ä¿®å¤ |
| Q8_0 | âš ï¸ ERROR | âš ï¸ ERROR | å¾…ä¿®å¤ (å†…å­˜å¯¹é½é—®é¢˜) |

### æ•°å€¼è¯¯å·®å¯¹æ¯”

**ä¿®å¤å‰ (Q4_1 ç¤ºä¾‹)**:
```
Reference: 0.497737
Kernel:    0.123456  âŒ è¯¯å·®: 75%
```

**ä¿®å¤å (Q4_1)**:
```
Reference: 0.497737
Kernel:    0.497738  âœ… è¯¯å·®: < 0.001%
```

---

## ğŸ”§ ä¿®å¤æ¸…å•

### å·²ä¿®å¤çš„æ–‡ä»¶

1. **`tests/framework/test_framework.cuh`**
   - âœ… ä¿®å¤ Q8_0 é‡åŒ–å‡½æ•°ï¼ˆé¡ºåºå­˜å‚¨ï¼‰
   - âœ… ä¿®å¤ Q5_0 é‡åŒ–å‡½æ•°ä¸­ qh å­˜å‚¨
   - âœ… ä¿®å¤ Q5_1 é‡åŒ–å‡½æ•°ä¸­ qh å­˜å‚¨

2. **`kernels/gemm/gemm_quant_formats.cuh`**
   - âœ… ä¿®å¤ Q4_1 kernel ä¸­ Q8_1 æ•°æ®åŠ è½½
   - âœ… ä¿®å¤ Q5_0 kernel ä¸­ Q8_1 æ•°æ®åŠ è½½å’Œ qh æå–
   - âœ… ä¿®å¤ Q5_1 kernel ä¸­ Q8_1 æ•°æ®åŠ è½½å’Œ qh æå–

3. **`tests/unit/test_gemm_all_quants.cu`**
   - âœ… ä¿®å¤ Q4_1 CPU å‚è€ƒå®ç°
   - âœ… ä¿®å¤ Q5_0 CPU å‚è€ƒå®ç°ä¸­ qh æå–
   - âœ… ä¿®å¤ Q5_1 CPU å‚è€ƒå®ç°ä¸­ qh æå–

---

## ğŸ’¡ å…³é”®å‘ç°

### 1. Q8_1 æ˜¯é¡ºåºå­˜å‚¨ï¼Œä¸æ˜¯äº¤é”™çš„

è¿™æ˜¯æœ€å…³é”®çš„å‘ç°ã€‚ä¹‹å‰çš„å®ç°é”™è¯¯åœ°å‡è®¾ Q8_1 åƒ Q4_0 ä¸€æ ·æ˜¯äº¤é”™å¸ƒå±€ï¼Œä½†å®é™…ä¸Šï¼š
- **Q8_1**: `qs[i] = x[i]` (é¡ºåº)
- **Q4_0/Q4_1/Q5_0/Q5_1**: `qs[i]` çš„ä½ nibble = `x[i]`, é«˜ nibble = `x[i+16]` (äº¤é”™)

### 2. qh å¸ƒå±€æ˜¯åˆ†æ®µï¼Œä¸æ˜¯äº¤é”™

å¯¹äº Q5_0/Q5_1:
- **é”™è¯¯å‡è®¾**: `bits 0,1,2,3,4,5,6,7` å¯¹åº” `x[0],x[16],x[1],x[17],x[2],x[18],x[3],x[19]`
- **å®é™…å¸ƒå±€**: `bits 0-15` å¯¹åº” `x[0..15]`, `bits 16-31` å¯¹åº” `x[16..31]`

### 3. GPU Kernel éœ€è¦åŒ¹é…æ•°æ®å¸ƒå±€

ä¸åŒçš„é‡åŒ–æ ¼å¼æœ‰ä¸åŒçš„æ•°æ®å¸ƒå±€ï¼ŒGPU kernel å¿…é¡»æ­£ç¡®åŒ¹é…ï¼š
- Q4_0: ä½¿ç”¨ `i` å’Œ `i + 4` åŠ è½½ Q8_1 âœ“
- Q4_1: åº”è¯¥ä½¿ç”¨ `i` å’Œ `i + 4`ï¼Œä½†é”™è¯¯ä½¿ç”¨äº† `2*i + 0` å’Œ `2*i + 1` âŒ

---

## ğŸ¯ å…³äº llama.cpp å®ç°çš„è¯´æ˜

### GPU Kernel å®ç°æ¥æº

**é—®é¢˜**: GPU å‚è€ƒå®ç°æ˜¯ llama.cpp çš„ç»“æœå—ï¼Ÿ

**å›ç­”**: 

1. **ç®—æ³•ä¸€è‡´æ€§**: âœ… æ˜¯
   - è¡¥å¿å…¬å¼ä¸ llama.cpp å®Œå…¨ä¸€è‡´
   - ç‚¹ç§¯è®¡ç®—é€»è¾‘ä¸ llama.cpp ä¸€è‡´
   - æ³¨é‡Šä¸­æ˜ç¡®æ ‡æ³¨ "ä¸ llama.cpp vec_dot_q4_0_q8_1_impl ä¸€è‡´"

2. **ä»£ç æ¥æº**: âš ï¸ ä¸æ˜¯ç›´æ¥å¤åˆ¶
   - GPU kernel æ˜¯**ç‹¬ç«‹å®ç°**ï¼Œä½†éµå¾ª llama.cpp çš„ç®—æ³•
   - æ•°æ®ç»“æ„ä¸ llama.cpp 100% å…¼å®¹
   - æ•°æ®å¸ƒå±€åº”è¯¥ä¸ llama.cpp ä¸€è‡´ï¼ˆè¿™æ˜¯æœ¬æ¬¡ä¿®å¤çš„é‡ç‚¹ï¼‰

3. **å‚è€ƒæ¥æº**:
   ```cpp
   // llama.cpp/ggml/src/ggml-cuda/vecdotq.cuh
   template <int vdr> static __device__ __forceinline__ float
   vec_dot_q4_0_q8_1_impl(
       const int * v, const int * u, const float & d4, const half2 & ds8) {
       int sumi = 0;
       for (int i = 0; i < vdr; ++i) {
           const int vi0 = (v[i] >> 0) & 0x0F0F0F0F;
           const int vi1 = (v[i] >> 4) & 0x0F0F0F0F;
           sumi = ggml_cuda_dp4a(vi0, u[2*i+0], sumi);
           sumi = ggml_cuda_dp4a(vi1, u[2*i+1], sumi);
       }
       return d4 * (sumi * ds8f.x - (8*vdr/QI4_0) * ds8f.y);
   }
   ```

4. **æœ¬é¡¹ç›®å®ç°**:
   ```cpp
   // kernels/gemm/gemm_quant_formats.cuh
   __device__ __forceinline__ float vec_dot_q4_0_q8_1(...) {
       int sumi = 0;
       for (int i = 0; i < 4; i++) {
           int vi0 = (v >> 0) & 0x0F0F0F0F;
           int vi1 = (v >> 4) & 0x0F0F0F0F;
           sumi = dp4a(vi0, u0, sumi);
           sumi = dp4a(vi1, u1, sumi);
       }
       return d4 * (d8 * sumi - 8.0f * s8);  // ç›¸åŒçš„è¡¥å¿å…¬å¼
   }
   ```

**æ€»ç»“**: 
- âœ… **ç®—æ³•**: ä¸ llama.cpp ä¸€è‡´
- âœ… **æ•°æ®ç»“æ„**: ä¸ llama.cpp å…¼å®¹
- âš ï¸ **å®ç°**: ç‹¬ç«‹ç¼–å†™ï¼Œä½†åº”è¯¥ä¸ llama.cpp è¡Œä¸ºä¸€è‡´
- âœ… **æ•°æ®å¸ƒå±€**: ä¿®å¤åä¸ llama.cpp ä¸€è‡´

---

## ğŸ“ ç»éªŒæ•™è®­

1. **æ•°æ®å¸ƒå±€æ˜¯å…³é”®**: å³ä½¿ç®—æ³•æ­£ç¡®ï¼Œæ•°æ®å¸ƒå±€é”™è¯¯ä¹Ÿä¼šå¯¼è‡´å®Œå…¨é”™è¯¯çš„ç»“æœ
2. **ä¸€è‡´æ€§æ£€æŸ¥**: ä¸åŒæ ¼å¼çš„å®ç°åº”è¯¥ä¿æŒä¸€è‡´çš„å‡è®¾ï¼ˆå¦‚ Q8_1 å¸ƒå±€ï¼‰
3. **å‚è€ƒå®ç°**: CPU å‚è€ƒå®ç°å¿…é¡»ä¸ GPU kernel ä½¿ç”¨ç›¸åŒçš„æ•°æ®å¸ƒå±€å‡è®¾
4. **æ–‡æ¡£é‡è¦æ€§**: æ¸…æ™°çš„æ³¨é‡Šè¯´æ˜æ•°æ®å¸ƒå±€å¯ä»¥é¿å…è¿™ç±»é”™è¯¯

---

## ğŸ”® å¾…è§£å†³é—®é¢˜

1. **Q8_0 å†…å­˜å¯¹é½é”™è¯¯**: "misaligned address" é”™è¯¯ï¼Œéœ€è¦æ£€æŸ¥å†…å­˜åˆ†é…
2. **æ€§èƒ½ä¼˜åŒ–**: å½“å‰å®ç°æ˜¯æ•™è‚²æ€§çš„ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-01-29  
**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-01-29  
**æµ‹è¯•çŠ¶æ€**: âœ… Q4_0, Q4_1, Q5_0, Q5_1 å…¨éƒ¨é€šè¿‡
