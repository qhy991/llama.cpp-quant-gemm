# æ•™ç¨‹ 00: é¡¹ç›®ä»‹ç»ä¸ç¯å¢ƒé…ç½®

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æ•™ç¨‹åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- [ ] ç†è§£æœ¬é¡¹ç›®çš„ç›®æ ‡å’Œç»“æ„
- [ ] é…ç½® CUDA å¼€å‘ç¯å¢ƒ
- [ ] è¿è¡Œç¬¬ä¸€ä¸ªæµ‹è¯•ç¨‹åº
- [ ] ç†è§£ä¸ llama.cpp çš„å…³ç³»

---

## 1. é¡¹ç›®ä»‹ç»

### 1.1 æˆ‘ä»¬è¦åšä»€ä¹ˆï¼Ÿ

æœ¬é¡¹ç›®çš„ç›®æ ‡æ˜¯**ä»é›¶å®ç° llama.cpp ä¸­çš„ CUDA ç®—å­**ï¼Œç”¨äºï¼š

1. **å­¦ä¹  CUDA ç¼–ç¨‹**: é€šè¿‡å®é™…é¡¹ç›®æ·±å…¥ç†è§£ GPU ç¼–ç¨‹
2. **ç†è§£ LLM æ¨ç†**: äº†è§£å¤§è¯­è¨€æ¨¡å‹æ¨ç†ä¸­çš„æ ¸å¿ƒè®¡ç®—
3. **æŒæ¡é‡åŒ–æŠ€æœ¯**: å­¦ä¹  4-bitã€8-bit é‡åŒ–çš„åŸç†å’Œå®ç°
4. **å®ç°å¯æ›¿æ¢çš„ç®—å­**: æˆ‘ä»¬çš„å®ç°å¯ä»¥ç›´æ¥æ›¿æ¢ llama.cpp ä¸­çš„å¯¹åº”ç®—å­

### 1.2 ä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªé¡¹ç›®ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     LLM æ¨ç†æµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   è¾“å…¥ Token                                                â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚   â”‚Embeddingâ”‚                                               â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                               â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚         Transformer Layer Ã— N       â”‚  â—„â”€â”€ æˆ‘ä»¬å…³æ³¨è¿™é‡Œ â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                   â”‚
â”‚   â”‚  â”‚ Attention (Q, K, V, O proj) â”‚   â”‚  â—„â”€â”€ GEMM        â”‚
â”‚   â”‚  â”‚ RMSNorm                      â”‚   â”‚  â—„â”€â”€ å½’ä¸€åŒ–      â”‚
â”‚   â”‚  â”‚ FFN (gate, up, down proj)   â”‚   â”‚  â—„â”€â”€ GEMM        â”‚
â”‚   â”‚  â”‚ SiLU, GELU                  â”‚   â”‚  â—„â”€â”€ æ¿€æ´»å‡½æ•°    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚   â”‚ LM Head â”‚  â—„â”€â”€ GEMM                                     â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                               â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚   è¾“å‡º Token                                                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒæ´å¯Ÿ**: LLM æ¨ç†çš„ 90%+ æ—¶é—´éƒ½èŠ±åœ¨çŸ©é˜µä¹˜æ³• (GEMM) ä¸Šï¼

### 1.3 ä¸ llama.cpp çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¶æ„å…³ç³»å›¾                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  quant-gemm-from-scratch          llama.cpp                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â•â•â•â•â•â•â•â•â•                 â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ compat/ggml_types.h â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ ggml/src/ggml-commonâ”‚   â”‚
â”‚  â”‚ (å¤åˆ¶çš„ç±»å‹å®šä¹‰)    â”‚  åŒæ­¥    â”‚                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                               â”‚                 â”‚
â”‚           â–¼                               â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ kernels/gemm/       â”‚  ç›¸åŒ   â”‚ ggml-cuda/mmq.cuh   â”‚   â”‚
â”‚  â”‚ gemm_dp4a.cuh       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚   â”‚
â”‚  â”‚ (æˆ‘ä»¬çš„å®ç°)        â”‚  æ¥å£   â”‚ (llama.cpp çš„å®ç°)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                               â”‚                 â”‚
â”‚           â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                 â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ å¯ä»¥æ›¿æ¢! â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**:
- æˆ‘ä»¬å®šä¹‰ä¸ llama.cpp å®Œå…¨ç›¸åŒçš„æ•°æ®ç±»å‹
- æˆ‘ä»¬çš„ kernel æ¥å£ä¸ llama.cpp ä¸€è‡´
- å› æ­¤å¯ä»¥ç›´æ¥æ›¿æ¢ llama.cpp ä¸­çš„ç®—å­

---

## 2. ç¯å¢ƒé…ç½®

### 2.1 ç¡¬ä»¶è¦æ±‚

| ç»„ä»¶ | æœ€ä½è¦æ±‚ | æ¨èé…ç½® |
|------|---------|---------|
| GPU | Turing (sm_75) | Ampere/Ada/Blackwell |
| æ˜¾å­˜ | 4GB | 8GB+ |
| CUDA Compute Capability | 7.5 | 8.0+ |

### 2.2 è½¯ä»¶è¦æ±‚

```bash
# æ£€æŸ¥ CUDA ç‰ˆæœ¬
nvcc --version
# éœ€è¦ CUDA 11.0+ï¼Œæ¨è 12.0+

# æ£€æŸ¥ GPU ä¿¡æ¯
nvidia-smi

# æ£€æŸ¥ Compute Capability
nvidia-smi --query-gpu=compute_cap --format=csv
```

### 2.3 å®‰è£…æ­¥éª¤

```bash
# 1. ç¡®ä¿ CUDA Toolkit å·²å®‰è£…
# Ubuntu:
sudo apt install nvidia-cuda-toolkit

# æˆ–è€…ä½¿ç”¨ conda:
conda install -c nvidia cuda-toolkit

# 2. è®¾ç½®ç¯å¢ƒå˜é‡
export CUDA_HOME=/usr/local/cuda
export PATH=$CUDA_HOME/bin:$PATH
export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

# 3. éªŒè¯å®‰è£…
nvcc --version
```

---

## 3. é¡¹ç›®ç»“æ„

```
quant-gemm-from-scratch/
â”‚
â”œâ”€â”€ compat/                      # å…¼å®¹å±‚
â”‚   â””â”€â”€ ggml_types.h            # llama.cpp å…¼å®¹ç±»å‹
â”‚
â”œâ”€â”€ kernels/                     # ç®—å­å®ç°
â”‚   â”œâ”€â”€ gemm/                   # çŸ©é˜µä¹˜æ³•
â”‚   â”‚   â”œâ”€â”€ gemm_naive.cuh      # æœ´ç´ å®ç°
â”‚   â”‚   â”œâ”€â”€ gemm_tiled.cuh      # Tiled å®ç°
â”‚   â”‚   â””â”€â”€ gemm_dp4a.cuh       # DP4A ä¼˜åŒ– âœ…
â”‚   â”œâ”€â”€ activation/             # æ¿€æ´»å‡½æ•°
â”‚   â””â”€â”€ normalization/          # å½’ä¸€åŒ–
â”‚
â”œâ”€â”€ tests/                       # æµ‹è¯•
â”‚   â”œâ”€â”€ framework/              # æµ‹è¯•æ¡†æ¶
â”‚   â””â”€â”€ unit/                   # å•å…ƒæµ‹è¯•
â”‚
â”œâ”€â”€ tutorials/                   # æ•™ç¨‹ ğŸ“š
â”‚   â”œâ”€â”€ 00-introduction/        # ä½ åœ¨è¿™é‡Œï¼
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ docs/                        # æ–‡æ¡£
```

---

## 4. ç¬¬ä¸€ä¸ªæµ‹è¯•

### 4.1 éªŒè¯ç¯å¢ƒ

åˆ›å»ºæ–‡ä»¶ `hello.cu`:

```cuda
// tutorials/00-introduction/hello.cu
#include <stdio.h>

__global__ void hello_kernel() {
    printf("Hello from GPU thread %d!\n", threadIdx.x);
}

int main() {
    printf("=== CUDA Environment Test ===\n\n");

    // è·å– GPU ä¿¡æ¯
    cudaDeviceProp prop;
    cudaGetDeviceProperties(&prop, 0);

    printf("GPU: %s\n", prop.name);
    printf("Compute Capability: %d.%d\n", prop.major, prop.minor);
    printf("Total Memory: %.2f GB\n", prop.totalGlobalMem / (1024.0*1024.0*1024.0));
    printf("SM Count: %d\n", prop.multiProcessorCount);
    printf("Max Threads/Block: %d\n", prop.maxThreadsPerBlock);
    printf("\n");

    // è¿è¡Œç®€å• kernel
    printf("Running hello kernel...\n");
    hello_kernel<<<1, 4>>>();
    cudaDeviceSynchronize();

    printf("\nâœ… CUDA environment is working!\n");
    return 0;
}
```

### 4.2 ç¼–è¯‘å’Œè¿è¡Œ

```bash
cd tutorials/00-introduction

# ç¼–è¯‘
nvcc -o hello hello.cu

# è¿è¡Œ
./hello
```

### 4.3 é¢„æœŸè¾“å‡º

```
=== CUDA Environment Test ===

GPU: NVIDIA GeForce RTX 5070 Laptop GPU
Compute Capability: 12.0
Total Memory: 7.96 GB
SM Count: 42
Max Threads/Block: 1024

Running hello kernel...
Hello from GPU thread 0!
Hello from GPU thread 1!
Hello from GPU thread 2!
Hello from GPU thread 3!

âœ… CUDA environment is working!
```

---

## 5. è¿è¡Œç°æœ‰æµ‹è¯•

### 5.1 è¿è¡Œ GEMM æµ‹è¯•

```bash
cd /home/haiyan/Agent4Kernel/quant-gemm-from-scratch

# ç¼–è¯‘æµ‹è¯•
cd tests
nvcc -o test_gemm_q4 unit/test_gemm_q4.cu \
    -I../compat -I../kernels \
    -std=c++17 -O3 --gpu-architecture=sm_120a

# è¿è¡Œ
./test_gemm_q4
```

### 5.2 è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

```bash
cd /home/haiyan/Agent4Kernel/llama.cpp/tests
./test_all_kernels
```

---

## 6. ä¸‹ä¸€æ­¥

æ­å–œä½ å®Œæˆäº†ç¯å¢ƒé…ç½®ï¼

**æ¥ä¸‹æ¥**:
- ç»§ç»­å­¦ä¹  [æ•™ç¨‹ 01: CUDA åŸºç¡€](../01-cuda-basics/)
- æˆ–è€…ç›´æ¥è·³åˆ° [æ•™ç¨‹ 02: æœ´ç´  GEMM å®ç°](../02-gemm-naive/)

---

## ğŸ“ ç»ƒä¹ 

1. ä¿®æ”¹ `hello.cu`ï¼Œå°è¯•ä½¿ç”¨æ›´å¤šçº¿ç¨‹ï¼ˆå¦‚ 256 ä¸ªï¼‰
2. æ·»åŠ  `blockIdx.x` çš„æ‰“å°ï¼Œä½¿ç”¨å¤šä¸ª block
3. æŸ¥çœ‹ä½ çš„ GPU çš„è¯¦ç»†è§„æ ¼ï¼ˆä½¿ç”¨ `deviceQuery` æˆ– `nvidia-smi -q`ï¼‰

---

## ğŸ”— å‚è€ƒèµ„æ–™

- [CUDA Quick Start Guide](https://docs.nvidia.com/cuda/cuda-quick-start-guide/)
- [CUDA Samples](https://github.com/NVIDIA/cuda-samples)
- [llama.cpp GitHub](https://github.com/ggerganov/llama.cpp)
